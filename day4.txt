istioctl profile list
	 istioctl install --set profile=demo -y
kubectl get ns
kubectl get get po -n istio-system
kubectl label namespace default istio-injection=enabled

kubectl get ns --show-labels

kubectl apply -f addons

kubectl get pod,svc -n istio-system

kubectl run nginx-webapp --image=nginx

 kubectl get po

 curl -v $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')/productpage



openssl req \
        -x509 \
        -newkey rsa:2048 \
        -keyout istio-elb.amazonaws.com.key.pem \
        -out istio-elb.amazonaws.com.cert.pem \
        -days 365 \
        -nodes \
        -subj '/CN=*.elb.amazonaws.com'


openssl x509 -in istio-elb.amazonaws.com.cert.pem -text -noout


kubectl create -n istio-system \
    secret tls gateway-cert-aws-elb-dns \
    --key=istio-elb.amazonaws.com.key.pem \
    --cert=istio-elb.amazonaws.com.cert.pem








openssl req \
        -x509 \
        -newkey rsa:2048 \
        -keyout istio-elb.sni.com.key.pem \
        -out istio-elb.sni.com.cert.pem \
        -days 365 \
        -nodes \
        -subj '/CN=*.sni.com'




kubectl create -n istio-system \
    secret tls gateway-cert-sni-dns \
    --key=istio-elb.sni.com.key.pem \
    --cert=istio-elb.sni.com.cert.pem



curl -k -v \
    https://$(echo $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')/productpage)


kubectl run curl \
    --restart Never \
    --image curlimages/curl \
    --dry-run -o yaml \
    -- /bin/sh -c "sleep infinity" > pod_curl.yaml



apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: curl
  name: curl
spec:
  containers:
  - args:
    - /bin/sh
    - -c
    - sleep infinity
    image: curlimages/curl
    name: curl
    resources: {}
  dnsPolicy: ClusterFirst
  restartPolicy: Never
status: {}
-----------




kubectl run curl --restart Never --image curlimages/curl -n non-istio --dry-run -o yaml -- /bin/sh -c "sleep infinity" > pod_curl_non_istio.yaml






----


apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system # global
  # namespace: default # namespace-wide policy
spec:
  mtls:
    mode: STRICT






SECURE_INGRESS_PORT=443
export INGRESS_HOST=$(echo $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'))
echo $INGRESS_HOST




TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-1.6/security/tools/jwt/samples/demo.jwt -s)
echo $TOKEN





curl $INGRESS_HOST/headers -v
  514  curl $INGRESS_HOST/headers -V
  515  SECURE_INGRESS_PORT=443
  516  export INGRESS_HOST=$(echo $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'))
  517  echo $INGRESS_HOST
  518  curl $INGRESS_HOST/headers -v
  519  curl --header "Authorization: Bearer dsdsdsdsd " $INGRESS_HOST/headers -v
  520  TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-1.6/security/tools/jwt/samples/demo.jwt -s)
  521  echo $TOKEN
  522  curl --header "Authorization: Bearer $TOKEN" $INGRESS_HOST/headers -v
  523  history

